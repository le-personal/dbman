#!/usr/bin/env node
var program = require("commander");
var request = require("request").defaults({jar: true});
var async = require("async");
var pkg = require("../package.json");
var version = pkg.version;
var util = require("util");
var exec = require("child_process").exec;

program
	.version(version);

program
	.command("backupall <uri> <email> <password>")
	.description("Create a backup")
	.option("--uri", "URI of dbman, Ej. http://dbman.example.com")
	.option("--email", "Email")
	.option("--password", "Password")
	.action(function(uri, username, password, options) {
		backupAll(uri, username, password, options);
	});

program
	.command("backup <uri> <email> <password> <database> [d]")
	.description("Create a backup")
	.option("--uri", "URI of dbman, Ej. http://dbman.example.com")
	.option("--email", "Email")
	.option("--password", "Password")
	.option("--database", "Database id")	
	.option("-d, --destination-path", "Download the backup once it finishes to the destination path provided")
	.action(function(uri, email, password, database, destinationpath, options) {
		backup(uri, email, password, database, destinationpath, options);
	});

program
	.command("test <uri> <email> <password>")
	.description("Test connection")
	.option("--uri", "URI of dbman, Ej. http://dbman.example.com")
	.option("--email", "Email")
	.option("--password", "Password")
	.action(function(uri, username, password, options) {
		testConnection(uri, username, password, options);
	});

program.parse(process.argv);

/**
 * Login to the host provided
 * @param  {string}   host     The host to connect to
 * @param  {string}   username The username to use on authentication
 * @param  {string}   password The password to use on authentication
 * @param  {Function} callback Callback to execute on completion
 * @return {Function}            The callback set in callback
 */
function _login(host, email, password, callback) {
	var uri = host + "/api/login";
	var user = {
		username: email,
		password: password
	}

	request.post({uri: uri, json: user}, function(error, response, body) {
		if(response.statusCode == 200) {
			return callback(false, body);
		}
		else {
			return callback(true, null);
		}
	});
}

/**
 * Get all databases
 * @param  {string}   host     The host to communicate to
 * @param  {Function} callback The callback to return on completion
 * @return {Function}            The callback set in callback
 */
function _getDatabases(host, callback) {
	var uri = host + "/api/databases";

	request
		.get(uri, function(error, res, body) {
			if(res.statusCode == 200) {
				return callback(false, JSON.parse(body));
			}
			else {
				return callback(true, null);
			}
		});		
}

/**
 * Get a specific database
 * @param  {string}   host     The host to communicate to
 * @param  {string}   id       The id of the database to get
 * @param  {Function} callback The callback to execute on completion
 * @return {Function}            The callback set in callback
 */
function _getDatabase(host, id, callback) {
	var uri = host + "/api/databases/" + id;
	request.get(uri, function(error, res, body) {
		if(res.statusCode == 200) {
			return callback(false, JSON.parse(body));
		}
		else {
			console.log("     The server responded with a status " + res.statusCode);
			return callback(true, null);
		}
	});
}

/**
 * Performs a backup by making a POST request to the website
 * @param  {string}   host     The host to connect to 
 * @param  {object}   database The database object
 * @param  {Function} callback Callback to execute on completion
 * @return {Function}            The callback set in callback
 */
function _performBackup(host, database, callback) {
	console.log("     Performing backup for database %s", database.database_name);
	var uri = host + "/api/databases/" + database._id + "/backups";

	var date = new Date();
	// create a string with the current time
	var now = date.getMonth() + "-" + date.getDay() + "-" + date.getFullYear() + "_" + date.getHours() + ":" + date.getUTCMinutes();
	
	// options to send, the filename will be the combination of the database name plus the current time
	var data = {
		name: database.database_name + "-" + now,
		format: "sql.gz"
	}

	request
		.post({uri: uri, json: data}, function(err, res, body) {
			if(res.statusCode == 201) {
				return callback(false, body);
			}
			else {
				return callback(true, null);
			}
		});
}

function _getBackup(host, databaseid, backupid, callback) {
	var uri = host + "/api/databases/" + databaseid + "/backups/" + backupid;
	request.get(uri, function(err, res, body) {
		if(res.statusCode == 200) {
			return callback(false, JSON.parse(body));
		}
		else {
			console.log("     The server responded with a status " + res.statusCode);
			return callback(true, null);
		}
	});
}

/**
 * Backup one database
 * @param  {string} host            The host to connect to
 * @param  {string} email        		The email to use to authenticate
 * @param  {string} password        The password to use to authenticate
 * @param  {string} databaseId      The database id to backup
 * @param  {string} destinationpath If provided, it will download the backup file to the destination provided
 * @param  {object} options         Object with options passed by commander
 * @return {void}                 
 */
function backup(host, email, password, databaseId, destinationpath, options) {
	console.log();
	_login(host, email, password, function(err, user) {
		if(err) {
			console.log("     There was an error with the email and the password you provied");
			console.log(err);
			process.exit(1);
		}
		if(user) {
			console.log("     Starting backup now of database " + databaseId);
			_getDatabase(host, databaseId, function(err, database) {
				if(err) {
					console.log("     There was a problem");
					return process.exit(1);
				}
				if(database) {
					_performBackup(host, database, function(err, backup) {
						console.log();
						console.log("     Finished backup for database " + database.database_name + " with filename " + backup.fileName);
						
						if(destinationpath) {
							console.log();
							console.log("     Waiting for the backup to finish before we start downloading it");
							console.log("     Please wait, this can take a few minutes depending on the size of the backup");
							console.log("     Once the backup finishes the download will start automatically");

							var backupStatus = "created";
							var counter = 0;
							async.until(
								function() {
									if(backupStatus == "finished") {
										console.log("     Starting download");
										return true;
									}
									if(backupStatus == "error") {
										return true;
									}

									return false;
								}, 
								function(callback) {
									console.log();
									console.log("     Waiting...");
									
									setTimeout(function() {
										_getBackup(host, database._id, backup._id, function(err, result) {
											counter++;
											console.log("     Status of backup is: " + result.status);
											console.log("     Trying again in 10 seconds");
											console.log();
											if(err) {
												backupStatus = "error";
											}

											backupStatus = result.status;
											// end after 20 tries
											if(counter == 20) {
												backupStatus = "error";
											}
											callback();
										});
									}, 10000);

								}, 
								function(err) {
									console.log();

									if(backupStatus == "finished") {
										exec("wget " + host + backup.url + " -P " + destinationpath, function(err, stdout, stderr) {
											if(stdout) console.log(stdout);
											if(stderr) console.log(stderr);
											if(err) console.log(err);

											process.exit();
										});
									}
									if(backupStatus == "error") {
										console.log("     There was an error creating the backup");
										return process.exit(1);
									}
								}
							);
						}
						else {
							console.log();
							return process.exit();
						}
					});
				}
			})

		}
	});
}

/**
 * Backup all databases
 * @param  {string} uri      URI of dbman
 * @param  {string} email 	Email to use to authenticate
 * @param  {string} password Password to use to authenticate
 * @param  {object} options  Object with options passed from commander
 * @return {void}          
 */
function backupAll(host, email, password, options) {
	_login(host, email, password, function(err, user) {
			console.log();
		if(err) {
			console.log("     There was an error with the email and the password you provied");
			console.log(err);
			process.exit(1);
		}
		if(user) {
			console.log("     Starting backup all now");
			_getDatabases(host, function(err, results) {
				var counter = 0;
				var total = results.length;

				// Loop through all databases
				results.forEach(function(result) {
					process.nextTick(function() {
						// Perform the backup by calling the function _performBackup
						_performBackup(host, result, function(err, results) {
							console.log("     Finished backup for database " + result.database_name + " with filename " + results.fileName);
							counter++;
							if(counter == total) {
								console.log();
								console.log("     Finished backing up all databases");
								console.log();
								process.exit();
							}
						});
					});
				})
			});
		}
	});
}

function testConnection(host, email, password, options) {
	var uri = host + "/api/login";
	var user = {
		username: email,
		password: password
	}

	request.post({uri: uri, json: user}, function(error, response, body) {
		request.get({uri: host + "/api/session"}, function(e, r, user) {
			if(r.statusCode == 200) {
				console.log("     Successfully connected to %s", host);
				console.log("     Using user: %s", user.fullName);
				process.exit();
			}
			else {
				console.log("     There was an error, got status: " + r.statusCode);
				process.exit(1);
			}
		})
	});
}